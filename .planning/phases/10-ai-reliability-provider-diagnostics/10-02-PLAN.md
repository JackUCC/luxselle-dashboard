---
phase: 10-ai-reliability-provider-diagnostics
plan: 02
type: execute
wave: 2
depends_on:
  - 10-01
files_modified:
  - src/pages/UnifiedIntelligence/UnifiedIntelligenceView.tsx
  - src/pages/BuyBox/EvaluatorView.tsx
  - src/pages/MarketResearch/MarketResearchView.tsx
autonomous: true
requirements:
  - STAB-01

must_haves:
  truths:
    - "When price check returns dataSource: 'provider_unavailable', UnifiedIntelligenceView shows a red/orange 'AI search unavailable' banner — not the amber 'No comparable listings found' box"
    - "When price check returns dataSource: 'provider_unavailable', EvaluatorView shows the same distinct error state"
    - "When market research returns providerStatus: 'unavailable', MarketResearchView shows a distinguishable 'AI unavailable' state (not the generic empty/degraded state)"
    - "The 'AI unavailable' state includes actionable guidance (check API keys)"
    - "Existing 'web_search' (Live data) and 'ai_fallback' (AI estimate) UI branches are unchanged"
  artifacts:
    - path: "src/pages/UnifiedIntelligence/UnifiedIntelligenceView.tsx"
      provides: "Third branch on dataSource === 'provider_unavailable' before comps list"
      contains: "provider_unavailable"
    - path: "src/pages/BuyBox/EvaluatorView.tsx"
      provides: "Third branch on dataSource === 'provider_unavailable'"
      contains: "provider_unavailable"
    - path: "src/pages/MarketResearch/MarketResearchView.tsx"
      provides: "Branch on providerStatus === 'unavailable' from API response"
      contains: "providerStatus"
  key_links:
    - from: "UnifiedIntelligenceView — result.dataSource"
      to: "red/orange provider unavailable banner (line ~767 comps area)"
      via: "result.dataSource === 'provider_unavailable' branch before result.comps.length check"
      pattern: "provider_unavailable"
    - from: "EvaluatorView — result.dataSource"
      to: "red/orange provider unavailable banner"
      via: "result.dataSource === 'provider_unavailable' branch"
      pattern: "provider_unavailable"
    - from: "MarketResearchView — API response data.providerStatus"
      to: "unavailable state UI"
      via: "marketResult?.providerStatus === 'unavailable'"
      pattern: "providerStatus"
---

<objective>
Add "AI unavailable" error states to the three frontend views that display price check or market
research results, so users see a clear, recoverable banner instead of the misleading "No comparable
listings found" amber box.

Purpose: Closes the user-facing gap of STAB-01 — users must be able to distinguish a provider failure
from a genuine lack of market data and get actionable guidance.
Output: Three updated frontend views with a distinct red/orange error state for provider failures.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-ai-reliability-provider-diagnostics/10-CONTEXT.md
@.planning/phases/10-ai-reliability-provider-diagnostics/10-01-SUMMARY.md
</context>

<interfaces>
<!-- Key existing UI contracts the executor needs. Extracted from codebase. -->

From src/pages/UnifiedIntelligence/UnifiedIntelligenceView.tsx (relevant sections):

The dataSource badge block (line ~649):
```tsx
{result.dataSource === 'web_search' ? (
  <span className="inline-flex items-center gap-1 rounded-full bg-emerald-50 px-2.5 py-0.5 text-xs font-medium text-emerald-700 ring-1 ring-emerald-600/20">
    <span className="h-1.5 w-1.5 rounded-full bg-emerald-500" />
    Live data
  </span>
) : result.dataSource === 'ai_fallback' ? (
  <span className="inline-flex items-center gap-1 rounded-full bg-amber-50 px-2.5 py-0.5 text-xs font-medium text-amber-700 ring-1 ring-amber-600/20">
    AI estimate
  </span>
) : null}
// ADD: } : result.dataSource === 'provider_unavailable' ? (...) : null}
```

The comps area (line ~707-769):
```tsx
{result.comps.length > 0 ? (
  <div>... comps list ...</div>
) : (
  <div className="rounded-lux-card border border-amber-200 bg-amber-50/50 p-5 text-sm text-amber-800">
    No comparable listings found. Prices shown are AI estimates and may be less reliable.
  </div>
)}
// REPLACE with 3-way branch:
// 1. provider_unavailable → red banner
// 2. comps.length > 0 → existing comps list
// 3. else → existing amber box
```

The `result` object type: `PriceCheckResult` from `@shared/schemas`
After Plan 10-01, PriceCheckResult.dataSource includes 'provider_unavailable'.

From src/pages/BuyBox/EvaluatorView.tsx (same pattern at line ~431):
```tsx
{result.dataSource === 'web_search' ? (
  // ... Live data badge
) : result.dataSource === 'ai_fallback' ? (
  // ... AI estimate badge
) : null}
// Same comps/empty rendering pattern below — locate and apply same 3-way branch
```

From src/pages/MarketResearch/MarketResearchView.tsx:
- The view imports MarketResearchResult from './types'
- Result state: `const [marketResult, setMarketResult] = useState<MarketResearchResult | null>(null)`
- After plan 10-01, the API response will contain data.providerStatus: 'available' | 'unavailable'
- The MarketResearchResult interface in types.ts needs providerStatus?: 'available' | 'unavailable' added
- Locate where the analysis result is rendered (the results panel) and add a top-level check:
  if marketResult?.providerStatus === 'unavailable', show the AI unavailable banner above or instead of the normal results
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Add provider_unavailable state to UnifiedIntelligenceView and EvaluatorView</name>
  <files>
    src/pages/UnifiedIntelligence/UnifiedIntelligenceView.tsx
    src/pages/BuyBox/EvaluatorView.tsx
  </files>
  <action>
    UnifiedIntelligenceView.tsx changes:

    1. Find the dataSource badge block (around line 649). Extend the ternary to add a third branch:
       ```tsx
       } : result.dataSource === 'provider_unavailable' ? (
         <span className="inline-flex items-center gap-1 rounded-full bg-red-50 px-2.5 py-0.5 text-xs font-medium text-red-700 ring-1 ring-red-600/20">
           AI unavailable
         </span>
       ) : null}
       ```

    2. Find the comps/empty state block (around line 707-769). Replace the 2-way branch with a 3-way branch:
       ```tsx
       {result.dataSource === 'provider_unavailable' ? (
         <div className="rounded-lux-card border border-red-200 bg-red-50/50 p-5 text-sm text-red-800">
           <p className="font-medium">AI search unavailable</p>
           <p className="mt-1 text-red-700">
             Check that OPENAI_API_KEY and/or PERPLEXITY_API_KEY are configured on the server, then retry.
           </p>
         </div>
       ) : result.comps.length > 0 ? (
         <div>
           ... (existing comps list — unchanged) ...
         </div>
       ) : (
         <div className="rounded-lux-card border border-amber-200 bg-amber-50/50 p-5 text-sm text-amber-800">
           No comparable listings found. Prices shown are AI estimates and may be less reliable.
         </div>
       )}
       ```

    EvaluatorView.tsx changes — apply the identical pattern:
    1. Find the dataSource badge block (around line 431) and add the same red 'AI unavailable' badge branch.
    2. Find the comps/empty state rendering and apply the same 3-way branch with the same red error box.

    Styling notes (use existing design system conventions):
    - Red variant: `border border-red-200 bg-red-50/50` (matches the amber pattern: `border border-amber-200 bg-amber-50/50`)
    - Text: `text-sm text-red-800` for body, `font-medium` for the heading line
    - Badge: `bg-red-50 text-red-700 ring-1 ring-red-600/20` (matches emerald/amber pattern)

    Do NOT change existing 'web_search' or 'ai_fallback' rendering. Minimal surgical edits only.
  </action>
  <verify>
    <automated>npm run typecheck</automated>
  </verify>
  <done>
    - UnifiedIntelligenceView.tsx has `provider_unavailable` in both badge and comps area
    - EvaluatorView.tsx has `provider_unavailable` in both badge and comps area
    - TypeScript type-checks clean (dataSource enum from Plan 10-01 includes the new value)
    - Existing 'web_search' and 'ai_fallback' branches are visually identical to before
  </done>
</task>

<task type="auto">
  <name>Task 2: Add provider unavailable state to MarketResearchView</name>
  <files>
    src/pages/MarketResearch/types.ts
    src/pages/MarketResearch/MarketResearchView.tsx
  </files>
  <action>
    types.ts changes:
    - Add `providerStatus?: 'available' | 'unavailable'` to the MarketResearchResult interface.
      This mirrors the providerStatus field added to the server-side MarketResearchResult in Plan 10-01.

    MarketResearchView.tsx changes:
    - Locate the section where analysis results are displayed (the `marketResult &&` render block or equivalent result panel).
    - Find where `MarketResearchResultPanel` or equivalent is rendered with the marketResult data.
    - Add a check BEFORE rendering the normal results: if `marketResult?.providerStatus === 'unavailable'`, show an AI unavailable banner:

    ```tsx
    {marketResult?.providerStatus === 'unavailable' && (
      <div className="rounded-lux-card border border-red-200 bg-red-50/50 p-5 text-sm text-red-800 mb-4">
        <p className="font-medium">AI search unavailable</p>
        <p className="mt-1 text-red-700">
          Check that OPENAI_API_KEY and/or PERPLEXITY_API_KEY are configured on the server, then retry.
        </p>
      </div>
    )}
    ```

    Note: This banner should render ABOVE (not instead of) the result panel, because the degraded
    analysis still provides some structural output (recommendation: 'hold', etc.) that may be
    marginally useful to the user. The banner makes it clear the numbers are not data-backed.

    Read the MarketResearchView.tsx file fully before editing to understand where results are rendered.
    The view imports MarketResearchResultPanel from './MarketResearchResultPanel' — find the JSX where
    it is used and insert the banner just before it, wrapped in the `marketResult` existence check.

    Run `npm run typecheck` to confirm the providerStatus field is accepted.
  </action>
  <verify>
    <automated>npm run typecheck</automated>
  </verify>
  <done>
    - types.ts MarketResearchResult has providerStatus?: 'available' | 'unavailable'
    - MarketResearchView.tsx renders red AI unavailable banner when providerStatus === 'unavailable'
    - Banner appears above (not replacing) the result panel
    - TypeScript type-checks clean
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
    Three frontend views now show distinct "AI search unavailable" red/orange banners when AI providers
    fail, instead of the misleading amber "No comparable listings found" box.

    To test locally with a simulated provider failure (without breaking real API keys):
    - The backend now returns dataSource: 'provider_unavailable' when SearchService detects all providers failed
    - You can verify the UI state by temporarily pointing to a backend where both keys are missing/invalid
    - Alternatively, inspect the JSX branching directly in the source to confirm the new branch is present
  </what-built>
  <how-to-verify>
    Option A — Code inspection (quickest):
    1. Open src/pages/UnifiedIntelligence/UnifiedIntelligenceView.tsx
    2. Search for 'provider_unavailable' — confirm it appears in both the badge block and the comps area
    3. Open src/pages/BuyBox/EvaluatorView.tsx — same check
    4. Open src/pages/MarketResearch/MarketResearchView.tsx — search for 'providerStatus'
    5. Open src/pages/MarketResearch/types.ts — confirm providerStatus field is present

    Option B — Live UI test (if API keys can be temporarily disabled):
    1. Set OPENAI_API_KEY=invalid and PERPLEXITY_API_KEY=invalid in .env then restart server
    2. Navigate to /evaluate, run any search
    3. Confirm red "AI search unavailable — Check that OPENAI_API_KEY..." banner appears
    4. Confirm the amber "No comparable listings found" box does NOT appear in its place
    5. Restore real API keys and restart server
  </how-to-verify>
  <resume-signal>Type "approved" if the UI branching is correct, or describe what is wrong</resume-signal>
</task>

</tasks>

<verification>
```bash
npm run typecheck
npm test
```

Both must pass. TypeScript typecheck confirms the new enum value and providerStatus field are
correctly typed throughout the frontend.
</verification>

<success_criteria>
1. UnifiedIntelligenceView shows red "AI search unavailable" banner when dataSource === 'provider_unavailable'
2. EvaluatorView shows the same distinct error state
3. MarketResearchView shows the AI unavailable banner when providerStatus === 'unavailable'
4. Existing 'web_search' (Live data) and 'ai_fallback' (AI estimate) branches are visually unchanged
5. npm run typecheck passes with no new errors
6. npm test passes (no regressions from frontend type changes)
</success_criteria>

<output>
After completion, create `.planning/phases/10-ai-reliability-provider-diagnostics/10-02-SUMMARY.md`
</output>
