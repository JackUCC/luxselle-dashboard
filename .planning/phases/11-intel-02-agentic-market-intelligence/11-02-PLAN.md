---
phase: 11-intel-02-agentic-market-intelligence
plan: 02
type: execute
wave: 2
depends_on:
  - "11-01"
files_modified:
  - packages/shared/src/schemas/savedResearch.ts
  - packages/server/src/services/market-research/MarketIntelMonitorService.ts
  - packages/server/src/services/market-research/MarketResearchService.ts
  - packages/server/src/services/market-research/MarketResearchService.test.ts
  - packages/server/src/routes/market-research.ts
  - packages/server/src/routes/market-research.test.ts
  - src/pages/MarketResearch/types.ts
autonomous: true
requirements: [INTEL-02]
must_haves:
  truths:
    - "On-demand deep-dive endpoint runs enriched research for a specific item and returns a tracked run id."
    - "Deep-dive output is persisted with provenance metadata so it can be revisited and audited."
    - "Deep-dive run records include cost/usage telemetry and provider chain details."
  artifacts:
    - path: "packages/server/src/routes/market-research.ts"
      provides: "POST deep-dive endpoint"
      contains: "/deep-dive"
    - path: "packages/server/src/services/market-research/MarketIntelMonitorService.ts"
      provides: "Deep-dive orchestration + telemetry persistence"
      contains: "runDeepDive"
    - path: "packages/shared/src/schemas/savedResearch.ts"
      provides: "Metadata extension for deep-dive result provenance"
      contains: "runId"
  key_links:
    - from: "market-research route"
      to: "MarketIntelMonitorService.runDeepDive"
      via: "validated deep-dive input"
      pattern: "runDeepDive"
    - from: "deep-dive run"
      to: "saved research metadata"
      via: "runId/provider/cost mapping"
      pattern: "deepDiveMeta"
---

<objective>
Add on-demand deep-dive execution for a specific item and persist enriched intelligence with run metadata.

Purpose: INTEL-02 requires both continuous monitoring and targeted high-detail research requests.
Output: `POST /api/market-research/deep-dive` flow with persistence and telemetry.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-intel-02-agentic-market-intelligence/11-CONTEXT.md
@.planning/phases/11-intel-02-agentic-market-intelligence/11-01-SUMMARY.md
@packages/server/src/routes/market-research.ts
@packages/server/src/services/market-research/MarketResearchService.ts
@packages/shared/src/schemas/savedResearch.ts
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Extend deep-dive input/output contracts and metadata types</name>
  <files>packages/shared/src/schemas/savedResearch.ts, src/pages/MarketResearch/types.ts</files>
  <action>Add deep-dive metadata fields (`runId`, `mode`, `snapshotAgeMinutes`, provider usage, estimated cost envelope) to saved research and frontend result typing without breaking existing read paths.</action>
  <verify>npm run typecheck</verify>
  <done>Contracts support deep-dive provenance and remain backward-compatible for existing saved research records.</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Implement deep-dive orchestration in monitor + market research services</name>
  <files>packages/server/src/services/market-research/MarketIntelMonitorService.ts, packages/server/src/services/market-research/MarketResearchService.ts, packages/server/src/services/market-research/MarketResearchService.test.ts</files>
  <action>Implement targeted deep-dive flow with enriched query variants, extended extraction context, and persisted run telemetry. Add tests for success, degraded, and provider-unavailable cases.</action>
  <verify>npm test -- packages/server/src/services/market-research/MarketResearchService.test.ts</verify>
  <done>Deep-dive service path produces enriched analysis plus run telemetry under all primary/error branches.</done>
</task>

<task type="auto" tdd="true">
  <name>Task 3: Add deep-dive route and contract tests</name>
  <files>packages/server/src/routes/market-research.ts, packages/server/src/routes/market-research.test.ts</files>
  <action>Expose `POST /api/market-research/deep-dive` endpoint, validate input payload, return run id + normalized research data, and cover route behavior with tests.</action>
  <verify>npm test -- packages/server/src/routes/market-research.test.ts</verify>
  <done>Deep-dive endpoint returns stable response shape and route tests cover validation, success, and degraded fallbacks.</done>
</task>

</tasks>

<verification>
- [ ] `npm run typecheck`
- [ ] `npm test -- packages/server/src/routes/market-research.test.ts`
- [ ] `npm test -- packages/server/src/services/market-research/MarketResearchService.test.ts`
</verification>

<success_criteria>
- On-demand deep-dive endpoint exists and is tested.
- Deep-dive results include run metadata and telemetry.
- Persisted records support auditability and later UI rendering.
</success_criteria>

<output>
After completion, create `.planning/phases/11-intel-02-agentic-market-intelligence/11-02-SUMMARY.md`
</output>
