---
phase: 12-inventory-invoice-verification-ml-01-signal-improvements
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - tests/e2e/invoices.spec.ts
  - packages/server/src/routes/invoices.test.ts
  - packages/server/src/routes/invoices.ts
  - packages/server/src/services/InvoicePdfService.ts
  - src/pages/Invoices/InvoicesView.tsx
autonomous: true
requirements: [QUAL-01]
must_haves:
  truths:
    - "Invoice create/list/save/export flows are covered by deterministic automated tests."
    - "Edge cases across invoice creation modes are validated with clear API error responses."
    - "PDF generation flow remains operational with failure handling tested."
  artifacts:
    - path: "tests/e2e/invoices.spec.ts"
      provides: "Expanded invoice E2E verification suite"
      contains: "Create in-person invoice"
    - path: "packages/server/src/routes/invoices.test.ts"
      provides: "Route-level invoice edge-case coverage"
      contains: "fromSale"
  key_links:
    - from: "invoice UI submit paths"
      to: "invoices route schema branches"
      via: "fromSale/fromInPerson/full create body"
      pattern: "fromInPerson"
---

<objective>
Run full invoice flow verification (API + UI), close defects, and lock stability with regression tests.

Purpose: Invoicing is operationally critical and must be deterministic before phase completion.
Output: Extended invoice tests and defect fixes across route/UI/PDF generation surfaces.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-inventory-invoice-verification-ml-01-signal-improvements/12-CONTEXT.md
@tests/e2e/invoices.spec.ts
@packages/server/src/routes/invoices.ts
@packages/server/src/routes/invoices.test.ts
@src/pages/Invoices/InvoicesView.tsx
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Expand invoices E2E matrix for create/save/export scenarios</name>
  <files>tests/e2e/invoices.spec.ts</files>
  <action>Add E2E coverage for create-mode variants, validation errors, pagination/list updates, and PDF export path assertions.</action>
  <verify>npm run test:e2e -- invoices.spec.ts</verify>
  <done>Invoices E2E suite covers all supported create/save/export user journeys including major edge cases.</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Harden invoices route tests and validation branches</name>
  <files>packages/server/src/routes/invoices.test.ts, packages/server/src/routes/invoices.ts</files>
  <action>Expand route tests for all create schema branches (`fromSale`, `fromInPerson`, full invoice), invalid payload handling, and pagination/filter behavior; patch route code if gaps appear.</action>
  <verify>npm test -- packages/server/src/routes/invoices.test.ts</verify>
  <done>Invoices route behavior is deterministic with explicit tests for success and validation failures.</done>
</task>

<task type="auto">
  <name>Task 3: Stabilize PDF generation and invoice UI error handling</name>
  <files>packages/server/src/services/InvoicePdfService.ts, src/pages/Invoices/InvoicesView.tsx</files>
  <action>Fix defects found in verification around PDF generation failures, user feedback, and state consistency after failed actions.</action>
  <verify>npm run typecheck</verify>
  <done>Invoice UI and PDF behavior handle failures gracefully and pass expanded tests.</done>
</task>

</tasks>

<verification>
- [ ] `npm run typecheck`
- [ ] `npm test -- packages/server/src/routes/invoices.test.ts`
- [ ] `npm run test:e2e -- invoices.spec.ts`
</verification>

<success_criteria>
- Invoice flows are fully validated across create/save/export paths.
- API validation behavior is predictable and tested.
- PDF generation failure/success paths are robust in both backend and UI.
</success_criteria>

<output>
After completion, create `.planning/phases/12-inventory-invoice-verification-ml-01-signal-improvements/12-02-SUMMARY.md`
</output>
